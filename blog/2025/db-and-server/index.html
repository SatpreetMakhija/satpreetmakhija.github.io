<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Your Codebase Reeks of Database Coupling; Hereâ€™s the Fix | Satpreet Makhija</title> <meta name="author" content="Satpreet Makhija"> <meta name="description" content="A guide on how to maintain your codebase for easy database switch"> <meta name="keywords" content="satpreet, satpreetmakhija, makhija"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://satpreetmakhija.github.io/blog/2025/db-and-server/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?6185d15ea1982787ad7f435576553d64"></script> </head> <body class="fixed-top-nav sticky-bottom-footer"> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">SatpreetÂ </span>Makhija</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">blog</a> </li> <li class="nav-item "> <a class="nav-link" href="/influences/">influences</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Your Codebase Reeks of Database Coupling; Hereâ€™s the Fix</h1> <p class="post-meta">January 29, 2025</p> <p class="post-tags"> <a href="/blog/2025"> <i class="fa-solid fa-calendar fa-sm"></i> 2025 </a> Â  Â· Â  <a href="/blog/tag/go"> <i class="fa-solid fa-hashtag fa-sm"></i> Go</a> Â  <a href="/blog/tag/database"> <i class="fa-solid fa-hashtag fa-sm"></i> Database</a> Â  <a href="/blog/tag/software-design"> <i class="fa-solid fa-hashtag fa-sm"></i> Software Design</a> Â  <a href="/blog/tag/abstraction"> <i class="fa-solid fa-hashtag fa-sm"></i> Abstraction</a> Â  Â  Â· Â  <a href="/blog/category/software-engineering"> <i class="fa-solid fa-tag fa-sm"></i> Software Engineering</a> Â  <a href="/blog/category/databases"> <i class="fa-solid fa-tag fa-sm"></i> Databases</a> Â  </p> </header> <article class="post-content"> <div id="markdown-content"> <p><strong>Ask yourself</strong>: <em>If I had to change the database in my codebase today, do I know what needs to be done?</em></p> <p>Chances are your palms are sweating, and you wonâ€™t be able to sleep tonight from such a horrifying question. If not, you donâ€™t need this post. For others, keep reading to sleep better tonight.</p> <p>Weâ€™ve all been through the arduous journey of building an application. You choose a database and stick with it. You donâ€™t even question what if I need to change the database and for good reasons. The current databaseâ€™s limitations reveals itself only when your application has high traffic. There are more reads, more writes, more updates that leads to sharding, indexing and what not. Letâ€™s be honest, most of your applications donâ€™t reach that state, if any. So, why bother?</p> <p>Good programming practices.</p> <p>Enough attention is paid to decoupling functions, objects, and classes in codebases, yet databases are often treated as immutable choices. Even if your database never changes, structuring your code to allow for such a change brings clarity and maintainability. Wouldnâ€™t it be reassuring to know that you could switch from MySQL to PostgreSQL with minimal effort?</p> <h3 id="the-north-star-abstraction">The North Star: Abstraction</h3> <p>Our goal is to organize the codebase so that switching databases is not impossible. The key is abstractions, spoiler alert. Weâ€™ll walk through an example of the proverbial software, a web app, below and see how to avoid decoupling of database with your codebase.</p> <p>Your web app has a backend written in Go and a PostgreSQL database. Youâ€™ve created a <code class="language-plaintext highlighter-rouge">users</code> table and defined a corresponding struct:</p> <div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">users</span> <span class="p">(</span>
    <span class="n">id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">,</span>
    <span class="n">name</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
    <span class="n">email</span> <span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span>
    <span class="n">age</span> <span class="nb">INT</span>
<span class="p">);</span>
</code></pre></div></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">User</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">ID</span>    <span class="kt">int</span>
    <span class="n">Name</span>  <span class="kt">string</span>
    <span class="n">Email</span> <span class="kt">string</span>
    <span class="n">Age</span>   <span class="kt">int</span>
<span class="p">}</span>
</code></pre></div></div> <p>A new feature requires offering discounts to users whoâ€™ve been active for six months. You add a <code class="language-plaintext highlighter-rouge">created_at</code> field to your database schema but fail to update the Go struct. This schema-struct inconsistency is your first mistake. A mismatch between the database schema and its in-memory representation is a ticking time bomb. The <code class="language-plaintext highlighter-rouge">user</code> struct is to store the idea of a user in memory. Why would you want an inconsistency between whatâ€™s stored in the table versus whatâ€™s present in memory? Youâ€™re asking for trouble when you do that.</p> <p>ðŸ‘‰ <strong>Always maintain a consistent mapping between table schemas and corresponding data structures.</strong></p> <h3 id="introducing-abstractions">Introducing Abstractions</h3> <p>You have an HTTP handler called <code class="language-plaintext highlighter-rouge">SignInHandler</code> whose job is to sign in users when they login for the first time. The <code class="language-plaintext highlighter-rouge">SignInHandler</code> must create users in the database, but it shouldnâ€™t know the specific database being used. To achieve this, introduce two abstractions:</p> <ol> <li> <strong>Repository abstraction</strong>: Handles direct database interactions.</li> <li> <strong>Model abstraction</strong>: Bridges business logic with the repository.</li> </ol> <h4 id="the-repository-layer">The Repository Layer</h4> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">UserRepo</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="n">CreateUser</span><span class="p">(</span><span class="n">user</span> <span class="n">User</span><span class="p">)</span> <span class="kt">error</span>
    <span class="n">GetUserByEmail</span><span class="p">(</span><span class="n">email</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// PostgreSQL implementation of UserRepo</span>
<span class="k">type</span> <span class="n">UserRepoPostgres</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">db</span> <span class="o">*</span><span class="n">sql</span><span class="o">.</span><span class="n">DB</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">UserRepoPostgres</span><span class="p">)</span> <span class="n">CreateUser</span><span class="p">(</span><span class="n">user</span> <span class="n">User</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Exec</span><span class="p">(</span><span class="s">"INSERT INTO users (name, email, age) VALUES ($1, $2, $3)"</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">Email</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">Age</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">err</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">r</span> <span class="o">*</span><span class="n">UserRepoPostgres</span><span class="p">)</span> <span class="n">GetUserByEmail</span><span class="p">(</span><span class="n">email</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">User</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">var</span> <span class="n">user</span> <span class="n">User</span>
    <span class="n">err</span> <span class="o">:=</span> <span class="n">r</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">QueryRow</span><span class="p">(</span><span class="s">"SELECT id, name, email, age FROM users WHERE email=$1"</span><span class="p">,</span> <span class="n">email</span><span class="p">)</span><span class="o">.</span>
        <span class="n">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user</span><span class="o">.</span><span class="n">Name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user</span><span class="o">.</span><span class="n">Email</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">user</span><span class="o">.</span><span class="n">Age</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">user</span><span class="p">,</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div> <p>The interface ensures flexibilityâ€”you can replace the database implementation without affecting consumers of <code class="language-plaintext highlighter-rouge">UserRepo</code>.</p> <h4 id="the-model-layer">The Model Layer</h4> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">UserModel</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">repo</span> <span class="n">UserRepo</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">UserModel</span><span class="p">)</span> <span class="n">CreateUser</span><span class="p">(</span><span class="n">user</span> <span class="n">User</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">Age</span> <span class="o">&lt;</span> <span class="m">18</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"user must be an adult"</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">m</span><span class="o">.</span><span class="n">repo</span><span class="o">.</span><span class="n">CreateUser</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> <p>At first, this may seem redundantâ€”why have <code class="language-plaintext highlighter-rouge">CreateUser</code> in both repository and model layers? But hereâ€™s a golden rule:</p> <p>ðŸ‘‰ <strong>Only models should interact with repositoriesâ€”no other part of the codebase should invoke repositories directly.</strong></p> <p>This boundary ensures:</p> <ul> <li>The repository layer only handles database interactions.</li> <li>The model layer orchestrates business logic before invoking the repository.</li> <li>Handlers (like <code class="language-plaintext highlighter-rouge">SignInHandler</code>) remain oblivious to the database implementation.</li> </ul> <p>You should note that the way we have setup the abstractions interaction, the <code class="language-plaintext highlighter-rouge">SignInHandler</code> knows only of the user model and user model knows only of the repository interface.</p> <h3 id="switching-databases">Switching Databases</h3> <p>Returning to our original question: <em>Where exactly do we need to make changes to switch databases?</em> Letâ€™s say weâ€™ll move from Postgres to MySQL. To do so, we do the following:</p> <ol> <li>Implement a new struct, <code class="language-plaintext highlighter-rouge">UserRepoMySQL</code>, that adheres to <code class="language-plaintext highlighter-rouge">UserRepo</code>.</li> <li>Use <code class="language-plaintext highlighter-rouge">UserRepoMySQL</code> instead of <code class="language-plaintext highlighter-rouge">UserRepoPostgres</code> when instantiating <code class="language-plaintext highlighter-rouge">UserModel</code>.</li> <li>Everything elseâ€”business logic, handlers, loggingâ€”remains unchanged.</li> </ol> <p>This structured approach ensures that <strong>only the repository layer changes</strong> during a database migration. There is a trade-off here. As your app codebase increases, youâ€™ll have many repository interfaces and when you perform a database switch, you will have to reimplement these interfaces from scratch. Thatâ€™s a lot of work. But, your business logic wonâ€™t need reimplementation as that stays in the model layer only. All other abstractions such as http handlers, loggers, etc too remain as is. Thatâ€™s a trade-off worth the repository interface reimplementation.</p> <p>ðŸ‘‰ <strong>Software doesnâ€™t become cumbersome when thereâ€™s a lot to doâ€”it becomes cumbersome when you canâ€™t pinpoint <em>where</em> things need to change.</strong></p> <p>Note, An actual database migration involves handling downtime, data transfer, and phased rollouts. But if your codebase follows these principles, switching databases becomes feasible at least from the codebase point of view.</p> <h3 id="faqs">FAQs</h3> <p><strong>Why not just merge repositories and models?</strong></p> <p>Business logic often extends beyond database operations. For example, if you need to trigger an ETL job when fetching high-spending users, this logic belongs in the model, not the repository. Keeping them separate prevents unnecessary complexity in database interactions.</p> <p><strong>I wonâ€™t change my database type. Should I care?</strong></p> <p>Yes! Even if your database remains unchanged, separating business logic from database interactions improves maintainability. Your codebase becomes easier to extend and debug.</p> <p><strong>What if data types differ between databases (e.g., MySQL vs. PostgreSQL)?</strong></p> <p>Rather than changing the core application logic, use helper functions to transform data types at the repository level. This keeps the rest of your application agnostic to database-specific differences.</p> </div> </article> </div> </div> <footer class="sticky-bottom mt-5"> <div class="container"> Â© Copyright 2025 Satpreet Makhija. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Last updated: May 23, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script defer src="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js?d633890033921b33e0ceb13d22340a9c"></script> <script defer src="/assets/js/common.js?acdb9690d7641b2f8d40529018c71a01"></script> <script defer src="/assets/js/copy_code.js?9b43d6e67ddc7c0855b1478ee4c48c2d" type="text/javascript"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>